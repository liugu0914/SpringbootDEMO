<div class="modal-content" id="selectMenu">
    <div class="modal-header modal-colored-header bg-dark">
        <h5 class="modal-title">配置菜单</h5>
        <div>
            <i class="cs cs-shuaxin pointer" show="tooltip" target="modal-reflesh" data-title="刷新"></i>
            <i class="cs cs-fangda pointer" show="tooltip" target="modal-expand" data-title="缩放"></i>
            <i class="cs cs-close pointer" show="tooltip" target="modal-close" data-title="关闭"></i>
        </div>
    </div>
    <div class="modal-body">
        <form class="pl-3 pr-3" action="/admin/permission/save">
            <input type="hidden" name="type" value="${(bean.type)!}">
            <input type="hidden" name="appid" value="${bean.appid}">
            <div class="form-group">
                <input class="form-control" type="text" name="target" value="${bean.target!''}"
                       placeholder="地址">
            </div>
            <div class="form-group">
                <ul id="treeDemo" target="ztree" data-url="/admin/permission/menuTree" check edit></ul>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" target="modal-close">关闭</button>
        <button type="button" class="btn btn-primary" target="form" data-bef="selectMenu.bef" data-suc="selectMenu.suc">
            保存
        </button>
    </div>
</div>
<script>
    $(function () {
        $('[target=ztree]', document).each(function (index, element) {
            if (!element.classList.contains('ztree')) {
                element.classList.add('ztree')
            }
            const $this = $(element)
            const check = element.hasAttribute('check')
            const edit = element.hasAttribute('edit')
            let autoParam = element.getAttribute('auto')
            autoParam = autoParam && typeof autoParam !== 'string' ? JSON.parse(autoParam) : ['id', 'pid']
            const url = $this.data('url')
            const params = $(this).data()
            if (params && params.url) {
                delete params.url
            }
            const setting = {// ztree config
                view: {
                    ...edit ? {
                        addHoverDom,
                        removeHoverDom
                    } : {},
                    selectedMulti: false
                },
                check: {
                    enable: check
                },
                edit: {
                    enable: edit
                },
                data: {
                    simpleData: {
                        enable: true,
                        idKey: 'id',
                        pIdKey: 'pid',
                        rootPId: 0
                    }
                },
                async: {
                    enable: true,
                    otherParam: params,
                    autoParam,
                    type: Ajax.POST,
                    url,
                    dataType: Ajax.JSON,
                    dataFilter: filter
                },
                callback: {
                    // beforeAsync: beforeAsync,
                    // onAsyncSuccess: onAsyncSuccess,
                    // onAsyncError: onAsyncError
                }
            }

            function filter(treeId, parentNode, datas) {
                if (!datas || !datas.data) return null;
                return datas.data;
            }

            var settings = {
                view: {
                    addHoverDom: addHoverDom,
                    removeHoverDom: removeHoverDom,
                    selectedMulti: false
                },
                check: {
                    enable: true
                },
                data: {
                    simpleData: {
                        enable: true
                    }
                },
                edit: {
                    enable: true
                }
            };

            var newCount = 1;

            function addHoverDom(treeId, treeNode) {
                var sObj = $("#" + treeNode.tId + "_span");
                if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0) return;
                var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                    + "' title='add node' onfocus='this.blur();'></span>";
                sObj.after(addStr);
                var btn = $("#addBtn_" + treeNode.tId);
                if (btn) btn.bind("click", function () {
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                    zTree.addNodes(treeNode, {id: (100 + newCount), pId: treeNode.id, name: "new node" + (newCount++)});
                    return false;
                });
            };

            function removeHoverDom(treeId, treeNode) {
                $("#addBtn_" + treeNode.tId).unbind().remove();
            };
            var zNodes = [
                {id: 1, pId: 0, name: "父节点1", open: true},
                {id: 11, pId: 1, name: "父节点11"},
                {id: 111, pId: 11, name: "叶子节点111"},
                {id: 112, pId: 11, name: "叶子节点112"},
                {id: 113, pId: 11, name: "叶子节点113"},
                {id: 114, pId: 11, name: "叶子节点114"},
                {id: 12, pId: 1, name: "父节点12"},
                {id: 121, pId: 12, name: "叶子节点121"},
                {id: 122, pId: 12, name: "叶子节点122"},
                {id: 123, pId: 12, name: "叶子节点123"},
                {id: 124, pId: 12, name: "叶子节点124"},
                {id: 13, pId: 1, name: "父节点13", isParent: true},
                {id: 2, pId: 0, name: "父节点2"},
                {id: 21, pId: 2, name: "父节点21", open: true},
                {id: 211, pId: 21, name: "叶子节点211"},
                {id: 212, pId: 21, name: "叶子节点212"},
                {id: 213, pId: 21, name: "叶子节点213"},
                {id: 214, pId: 21, name: "叶子节点214"},
                {id: 22, pId: 2, name: "父节点22"},
                {id: 221, pId: 22, name: "叶子节点221"},
                {id: 222, pId: 22, name: "叶子节点222"},
                {id: 223, pId: 22, name: "叶子节点223"},
                {id: 224, pId: 22, name: "叶子节点224"},
                {id: 23, pId: 2, name: "父节点23"},
                {id: 231, pId: 23, name: "叶子节点231"},
                {id: 232, pId: 23, name: "叶子节点232"},
                {id: 233, pId: 23, name: "叶子节点233"},
                {id: 234, pId: 23, name: "叶子节点234"},
                {id: 3, pId: 0, name: "父节点3", isParent: true}
            ];
            // $.fn.zTree.init($this, settings ,zNodes);
            var ztree = $.fn.zTree.init($this, setting);
            $this.data('ztree', ztree);
        });
    });
    var selectMenu = {
        bef: function ($this, data) {
            var ztree = $('#treeDemo').data('ztree');
            var datas = {nodes: []};
            if (ztree)
                datas.nodes = ztree.getChangeCheckedNodes();
            return datas;
        }
    }
    //# sourceURL=selectMenu.js
</script>